<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai Fund Engine v8.2 (Batch Grid Search)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    animation: { 'spin-slow': 'spin 3s linear infinite' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        
        .modern-card {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .tab-btn.active { color: #2563eb; border-bottom: 2px solid #2563eb; background-color: #eff6ff; }
        .tab-btn { color: #64748b; padding: 8px 16px; transition: all 0.2s; border-radius: 8px 8px 0 0; }

        /* Table Styling */
        .rebal-table th { background-color: #f1f5f9; color: #475569; font-weight: 600; font-size: 0.75rem; padding: 8px; text-align: right; }
        .rebal-table td { border-bottom: 1px solid #e2e8f0; padding: 8px; font-size: 0.75rem; text-align: right; color: #334155; }
        .rebal-table tr:last-child td { border-bottom: none; }
        .rebal-table td:first-child, .rebal-table th:first-child { text-align: left; }
        
        .batch-row:hover { background-color: #f8fafc; cursor: pointer; }
        .batch-row.selected { background-color: #eff6ff; border-left: 4px solid #3b82f6; }

        .info-btn { 
            cursor: pointer; color: #94a3b8; font-size: 0.75rem; margin-left: 4px;
            display: inline-flex; align-items: center; justify-content: center;
            width: 16px; height: 16px; border-radius: 50%; border: 1px solid #cbd5e1;
            transition: all 0.2s;
        }
        .info-btn:hover { color: #3b82f6; border-color: #3b82f6; background-color: #eff6ff; }

        .loader {
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #3498db; 
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body class="text-slate-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                    </svg>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight text-slate-800">Thai Fund Engine <span class="text-blue-600">v8.2</span></h1>
                    <p class="text-xs text-slate-500">Batch Quant Analytics & Grid Search</p>
                </div>
            </div>

            <div class="flex gap-4 items-center">
                <div class="hidden md:flex gap-2 bg-slate-100 p-1 rounded-lg">
                    <button onclick="switchTab('simulator')" id="tab-sim" class="tab-btn active text-xs font-bold">Quant Dashboard</button>
                    <button onclick="switchTab('history')" id="tab-hist" class="tab-btn text-xs font-bold">Allocation Log</button>
                    <button onclick="switchTab('docs')" id="tab-docs" class="tab-btn text-xs font-bold">Methodology</button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-7xl w-full mx-auto px-4 py-8 space-y-8">

        <!-- VIEW 1: DASHBOARD -->
        <div id="view-simulator">
            <div class="flex flex-col lg:flex-row gap-8">
                
                <!-- LEFT PANEL: CONTROLS -->
                <div class="w-full lg:w-1/3 space-y-6">
                    
                    <!-- 1. Strategy Config -->
                    <div class="modern-card p-6 border-t-4 border-t-blue-500">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider">1. Strategy Logic</h3>
                            <span class="info-btn" onclick="showInfo('strategy')">?</span>
                        </div>
                        
                        <div class="mb-4">
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1.5 block">Rebalance Strategy</label>
                            <div class="relative">
                                <select id="strategy-select" onchange="updateStrategyDesc()" class="w-full bg-slate-50 border border-slate-200 rounded-lg text-xs py-2 px-3 focus:border-blue-500 outline-none appearance-none font-medium text-slate-700">
                                    <optgroup label="Simple Weighting">
                                        <option value="Rank_All">Rank All (Weight by Rank)</option>
                                        <option value="Equal_Weight">Equal Weight (All Assets)</option>
                                    </optgroup>
                                    <optgroup label="Momentum / Top-K">
                                        <option value="Top3_Equal" selected>Top 3 Equal Weight</option>
                                        <option value="Top3_Rank">Top 3 Weighted by Rank</option>
                                        <option value="Top50pct">Top 50% of Universe</option>
                                        <option value="AbsMom">Absolute Momentum (>0)</option>
                                        <option value="DualMom_Rel">Dual Momentum (Relative)</option>
                                    </optgroup>
                                    <optgroup label="Risk Based">
                                        <option value="InvVol">Inverse Volatility</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>

                        <!-- Description Box -->
                        <div id="strat-desc" class="bg-blue-50 border border-blue-100 p-3 rounded-lg text-xs text-blue-800 leading-relaxed mb-4 min-h-[60px]">
                            <!-- JS will update this -->
                        </div>

                        <!-- Asset Universe -->
                        <div class="mb-2 flex justify-between items-center">
                            <div class="flex items-center">
                                <label class="text-[10px] font-bold text-slate-500 uppercase">Asset Universe</label>
                                <span class="info-btn" onclick="showInfo('universe')">?</span>
                            </div>
                            <button onclick="resetDefaultAssets()" class="text-[10px] text-blue-500 hover:underline">Reset Default</button>
                        </div>
                        <div id="asset-list" class="space-y-2 mb-4 max-h-[150px] overflow-y-auto pr-1"></div>
                        <button onclick="addAsset()" class="w-full py-2 border-2 border-dashed border-slate-200 rounded-lg text-slate-500 hover:border-blue-500 hover:text-blue-600 text-xs font-bold transition-all">+ Add Asset</button>
                    </div>

                    <!-- 2. Parameters -->
                    <div class="modern-card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">2. Execution Parameters</h3>
                            <span class="text-[10px] text-blue-600 bg-blue-50 px-2 py-1 rounded-full font-bold">Supports Multiple Values</span>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-4 mb-4">
                            <div>
                                <div class="flex items-center mb-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase">Lookback (Days)</label>
                                    <span class="info-btn" onclick="showInfo('lookback')">?</span>
                                </div>
                                <input type="text" id="param-lookback" value="60, 120, 252" class="w-full bg-slate-50 border border-slate-200 rounded text-sm p-2 text-slate-700 font-mono placeholder-slate-400" placeholder="e.g. 60, 120, 200">
                                <p class="text-[9px] text-slate-400 mt-1">Comma separated for batch test</p>
                            </div>
                            <div>
                                <div class="flex items-center mb-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase">Rebalance (Days)</label>
                                    <span class="info-btn" onclick="showInfo('rebalance')">?</span>
                                </div>
                                <input type="text" id="param-rebal" value="20" class="w-full bg-slate-50 border border-slate-200 rounded text-sm p-2 text-slate-700 font-mono placeholder-slate-400" placeholder="e.g. 20, 60">
                                <p class="text-[9px] text-slate-400 mt-1">Comma separated for batch test</p>
                            </div>
                        </div>

                        <div class="border-t border-slate-100 pt-3 mb-4">
                            <div class="flex items-center mb-2">
                                <label class="text-[10px] font-bold text-slate-500 uppercase block">Costs (Reality Check)</label>
                                <span class="info-btn" onclick="showInfo('costs')">?</span>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[10px] text-slate-400 mb-1 block">T-Cost (Turnover)</label>
                                    <input type="number" id="cost-tcost" value="0.10" step="0.01" class="w-full bg-slate-50 border border-slate-200 rounded text-sm p-2 text-right text-rose-600 font-medium font-mono">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-400 mb-1 block">Annual Expense</label>
                                    <input type="number" id="cost-er" value="0.50" step="0.01" class="w-full bg-slate-50 border border-slate-200 rounded text-sm p-2 text-right text-rose-600 font-medium font-mono">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1.5 block">Backtest Range</label>
                            <div class="flex gap-2">
                                <input type="date" id="date-start" class="w-full bg-slate-50 border border-slate-200 rounded-lg text-xs py-2 px-2">
                                <input type="date" id="date-end" class="w-full bg-slate-50 border border-slate-200 rounded-lg text-xs py-2 px-2">
                            </div>
                        </div>

                        <button id="btn-run" onclick="runBatchEngine()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all">
                            <span>Run Batch Backtest</span>
                        </button>
                    </div>
                </div>

                <!-- RIGHT PANEL: VISUALIZATION -->
                <div class="w-full lg:w-2/3 space-y-6">
                    
                    <div id="results-container" class="hidden space-y-6">
                        
                        <!-- Batch Summary Table -->
                        <div class="modern-card p-6 border-l-4 border-blue-500">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h2 class="text-lg font-bold text-slate-800">Batch Comparison</h2>
                                    <p class="text-xs text-slate-500">Showing all combinations. Click row to view details.</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded">Best Sharpe Selected</span>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-xs text-right">
                                    <thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-200">
                                        <tr>
                                            <th class="p-2 text-left">Lookback</th>
                                            <th class="p-2 text-left">Rebal</th>
                                            <th class="p-2">CAGR</th>
                                            <th class="p-2">Sharpe</th>
                                            <th class="p-2">MaxDD</th>
                                            <th class="p-2">Turnover</th>
                                        </tr>
                                    </thead>
                                    <tbody id="batch-table-body" class="text-slate-700">
                                        <!-- Rows Injected Here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Selected Result Details -->
                        <div id="single-result-view" class="space-y-6 animate-fade-in">
                            <!-- Key Stats -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="modern-card p-4 border-l-4 border-emerald-500">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">CAGR (After Cost)</div>
                                    <div id="res-cagr" class="text-2xl font-bold text-emerald-600">-</div>
                                </div>
                                <div class="modern-card p-4">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Sharpe Ratio</div>
                                    <div id="res-sharpe" class="text-2xl font-bold text-blue-600">-</div>
                                </div>
                                <div class="modern-card p-4">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Max Drawdown</div>
                                    <div id="res-mdd" class="text-2xl font-bold text-rose-600">-</div>
                                </div>
                                <div class="modern-card p-4">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Turnover / Year</div>
                                    <div id="res-turnover" class="text-2xl font-bold text-slate-600">-</div>
                                </div>
                            </div>

                            <!-- Main Equity Curve -->
                            <div class="modern-card p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-lg font-bold text-slate-800">Growth Analysis</h2>
                                    <div class="flex gap-4 text-xs">
                                        <span class="flex items-center gap-1"><span class="w-3 h-3 bg-emerald-500 rounded-full"></span> Before Cost</span>
                                        <span class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-600 rounded-full"></span> After Cost</span>
                                    </div>
                                </div>
                                <div class="h-[300px]">
                                    <canvas id="chart-equity"></canvas>
                                </div>
                            </div>

                            <!-- INVESTOR ANALYSIS -->
                            <div class="bg-slate-50 rounded-xl p-6 border border-slate-200">
                                <div class="text-center mb-6">
                                    <h2 class="text-xl font-bold text-slate-800">Rolling Horizon Analysis</h2>
                                    <p class="text-sm text-slate-500">ถ้าเริ่มลงทุน "วันไหนก็ได้" ในอดีต ผลลัพธ์จะเป็นอย่างไร?</p>
                                </div>
                                
                                <div class="modern-card p-6 mb-6">
                                    <h3 class="text-sm font-bold text-slate-700 mb-2">1. Return Range (LUMP SUM vs DCA)</h3>
                                    <div class="h-[300px]">
                                        <canvas id="chart-range"></canvas>
                                    </div>
                                </div>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="modern-card p-6">
                                        <h3 class="text-sm font-bold text-slate-700 mb-2">2. Loss Probability</h3>
                                        <div class="h-[200px]">
                                            <canvas id="chart-loss"></canvas>
                                        </div>
                                    </div>
                                    <div class="modern-card p-6">
                                        <h3 class="text-sm font-bold text-slate-700 mb-2">3. Expected Return</h3>
                                        <div class="h-[200px]">
                                            <canvas id="chart-expected"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Placeholder -->
                    <div id="placeholder-viz" class="h-96 flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50">
                        <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                        <p class="text-sm font-medium">Configure parameters (comma separated supported) and Run</p>
                    </div>

                </div>
            </div>
        </div>

        <!-- VIEW 2: ALLOCATION HISTORY -->
        <div id="view-history" class="hidden max-w-7xl mx-auto space-y-6">
             <div class="modern-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-800">Rebalance History Log</h2>
                    <span class="text-xs text-slate-500">(Showing log for selected batch result)</span>
                </div>
                <div class="overflow-x-auto rounded-lg border border-slate-200">
                    <table class="w-full rebal-table" id="history-table">
                        <thead class="bg-slate-50">
                            <!-- JS will populate header -->
                        </thead>
                        <tbody class="bg-white">
                            <!-- JS will populate rows -->
                        </tbody>
                    </table>
                </div>
                <div id="history-placeholder" class="text-center text-slate-400 py-12 text-sm italic">
                    Run the simulation to see allocation history.
                </div>
             </div>
        </div>

        <!-- VIEW 3: METHODOLOGY (Docs) -->
        <div id="view-docs" class="hidden max-w-4xl mx-auto my-8 space-y-8 animate-fade-in">
             <div class="bg-white rounded-2xl p-8 border border-slate-100 shadow-sm">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Parameter Guide</h3>
                <div class="space-y-4 text-sm text-slate-600">
                    <p><strong>Lookback:</strong> จำนวนวันที่ใช้มองย้อนหลังเพื่อคำนวณผลตอบแทนหรือความผันผวน (เช่น 60 วัน, 120 วัน)</p>
                    <p><strong>Rebalance:</strong> ความถี่ในการปรับพอร์ต (เช่น ทุก 20 วันทำการ = 1 เดือน)</p>
                    <p><strong>T-Cost:</strong> ต้นทุนการซื้อขายจริง (Slippage + Commission) คิดเป็น % จากมูลค่าที่หมุนเวียน</p>
                    <p><strong>Expense Ratio:</strong> ค่าธรรมเนียมการจัดการกองทุน (Management Fee) รายปี</p>
                </div>
             </div>
        </div>

    </main>

    <!-- Info Modal -->
    <div id="info-modal" class="fixed inset-0 z-[100] bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4" onclick="if(event.target===this) closeInfo()">
        <div class="bg-white p-6 max-w-sm w-full rounded-2xl shadow-xl transform transition-all">
            <h3 id="info-title" class="text-lg font-bold text-slate-800 mb-2">Title</h3>
            <p id="info-desc" class="text-sm text-slate-600 leading-relaxed mb-6">Description</p>
            <button onclick="closeInfo()" class="w-full py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-lg transition-colors">Close</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[60] bg-white/90 backdrop-blur-sm hidden flex-col items-center justify-center">
        <div class="loader mb-4 border-t-blue-500"></div>
        <div class="text-lg font-bold text-slate-700">Running Batch Analysis...</div>
        <div id="loading-status" class="text-sm text-slate-500 mt-2">Crunching numbers</div>
    </div>

<script>
    // --- 0. CONFIGURATION & STATE ---
    const DEFAULT_ASSETS = ["QQQ", "SPY", "TLT", "GLD", "DBC", "UUP"];
    let STATE = {
        assets: [...DEFAULT_ASSETS],
        batchResults: [], // Array of simulation results
        selectedResultIndex: 0
    };
    let charts = {};

    const STRAT_DESCS = {
        "Rank_All": "เรียงลำดับสินทรัพย์ตามผลตอบแทนย้อนหลัง (Lookback) ตัวที่ชนะอันดับ 1 ได้น้ำหนักมากสุด ลดหลั่นลงไป",
        "Equal_Weight": "กระจายความเสี่ยงเท่าๆ กันในทุกสินทรัพย์ โดยไม่สนใจผลตอบแทนในอดีต (Passive Rebalance)",
        "Top3_Equal": "คัดเลือก 3 ตัวท็อปที่แกร่งที่สุดในช่วงเวลา Lookback แล้วถือตัวละ 33.3% เท่ากัน ตัดตัวอ่อนทิ้ง",
        "Top3_Rank": "คัดเลือก 3 ตัวท็อป แล้วถ่วงน้ำหนักตามความแรง (ที่ 1 ได้เยอะกว่าที่ 2 และ 3)",
        "Top50pct": "เลือกสินทรัพย์ครึ่งบนของตาราง (เช่น 3 ตัวจาก 6 ตัว) แล้วถือเท่ากัน",
        "AbsMom": "ถือเฉพาะตัวที่เป็นขาขึ้น (Trend > 0) เท่านั้น ตัวไหนเป็นขาลงจะขายทิ้ง (ไม่ถือ)",
        "DualMom_Rel": "ลูกผสม: เลือกตัวที่แกร่งกว่าเพื่อน (Relative) และต้องเป็นขาขึ้นด้วย (Absolute)",
        "InvVol": "เน้นความปลอดภัย: ให้ความสำคัญกับตัวที่ผันผวนต่ำ (Low Risk) โดยลงเงินเยอะกว่าตัวที่ผันผวนสูง"
    };

    const INFO_TEXTS = {
        "strategy": "กฎการลงทุนที่ใช้ตัดสินใจเลือกสินทรัพย์และกำหนดน้ำหนักการลงทุนในแต่ละรอบ",
        "universe": "กลุ่มของสินทรัพย์ที่เราสนใจจะลงทุน (เช่น หุ้นสหรัฐ, ทองคำ, พันธบัตร) ระบบจะเลือกเฉพาะตัวที่ดีที่สุดจากกลุ่มนี้",
        "lookback": "ช่วงเวลาที่ใช้มองย้อนหลัง (วัน) เพื่อวัดความแรง (Momentum) หรือความผันผวน ใส่หลายค่าได้โดยใช้เครื่องหมายจุลภาคคั่น เช่น '60, 120'",
        "rebalance": "ความถี่ในการปรับพอร์ต (วัน) เช่น 20 วัน (ประมาณ 1 เดือน) ใส่หลายค่าได้ เช่น '20, 60'",
        "costs": "ต้นทุนเสมือนจริงเพื่อให้ผลลัพธ์ไม่สวยหรูเกินจริง (T-Cost = ค่าคอมฯ+Slippage, Expense = ค่าธรรมเนียมกองทุน)"
    };

    function updateStrategyDesc() {
        const val = document.getElementById('strategy-select').value;
        const txt = STRAT_DESCS[val] || "";
        document.getElementById('strat-desc').innerText = txt;
    }

    function showInfo(key) {
        document.getElementById('info-title').innerText = key.toUpperCase();
        document.getElementById('info-desc').innerText = INFO_TEXTS[key] || "No description available.";
        document.getElementById('info-modal').classList.remove('hidden');
        document.getElementById('info-modal').classList.add('flex');
    }
    function closeInfo() {
        document.getElementById('info-modal').classList.add('hidden');
        document.getElementById('info-modal').classList.remove('flex');
    }

    // --- 1. DATA FETCHING ---
    const CACHE = {};
    async function fetchAssetData(symbol, startDate, endDate) {
        const cacheKey = `${symbol}-${startDate}-${endDate}`;
        if (CACHE[cacheKey]) return CACHE[cacheKey];

        const p1 = Math.floor(new Date(startDate).getTime() / 1000);
        const p2 = Math.floor(new Date(endDate).getTime() / 1000);
        const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${p1}&period2=${p2}&interval=1d&events=history&includeAdjustedClose=true`;
        const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);

        try {
            const res = await fetch(proxyUrl);
            const json = await res.json();
            const result = json.chart.result[0];
            if (!result || !result.timestamp) throw new Error("No Data");
            
            const adjClose = result.indicators.adjclose[0].adjclose;
            const timestamps = result.timestamp;
            
            return timestamps.map((t, i) => ({
                date: new Date(t * 1000).toISOString().split('T')[0],
                price: adjClose[i]
            })).filter(d => d.price != null);
        } catch (e) {
            console.warn(`Failed to fetch ${symbol}`, e);
            return null;
        }
    }

    // --- 2. CORE MATH ---
    function calcReturns(priceArr, lookback) {
        const res = new Array(priceArr.length).fill(NaN);
        for(let i = lookback; i < priceArr.length; i++) {
            res[i] = (priceArr[i] / priceArr[i - lookback]) - 1;
        }
        return res;
    }

    function calcVol(dailyRets, lookback) {
        const res = new Array(dailyRets.length).fill(NaN);
        for(let i = lookback; i < dailyRets.length; i++) {
            const window = dailyRets.slice(i - lookback + 1, i + 1);
            const mean = window.reduce((a,b)=>a+b,0) / window.length;
            const variance = window.reduce((a,b) => a + Math.pow(b-mean, 2), 0) / (window.length - 1);
            res[i] = Math.sqrt(variance);
        }
        return res;
    }

    function getWeights(strategy, signals, vols, dateIdx, assetKeys) {
        const activeAssets = assetKeys.filter(k => !isNaN(signals[k]));
        if (activeAssets.length === 0) return {};

        const sVals = activeAssets.map(k => ({ k, val: signals[k], vol: vols[k] }));
        sVals.sort((a,b) => b.val - a.val);

        let weights = {};
        assetKeys.forEach(k => weights[k] = 0);

        if (strategy === "Rank_All") {
            const N = sVals.length;
            const sumRanks = (N * (N + 1)) / 2;
            sVals.forEach((item, idx) => weights[item.k] = (N - idx) / sumRanks);
        } 
        else if (strategy === "Equal_Weight") {
             const w = 1 / sVals.length;
             sVals.forEach(item => weights[item.k] = w);
        }
        else if (strategy === "Top3_Equal") {
            const K = Math.min(3, sVals.length);
            const w = 1 / K;
            for(let i=0; i<K; i++) weights[sVals[i].k] = w;
        } 
        else if (strategy === "Top3_Rank") {
            const K = Math.min(3, sVals.length);
            const sumRanks = (K * (K + 1)) / 2;
            for(let i=0; i<K; i++) weights[sVals[i].k] = (K - i) / sumRanks;
        }
        else if (strategy === "Top50pct") {
            const K = Math.max(1, Math.floor(sVals.length / 2));
            const w = 1 / K;
            for(let i=0; i<K; i++) weights[sVals[i].k] = w;
        }
        else if (strategy === "AbsMom") {
            const pos = sVals.filter(x => x.val > 0);
            if(pos.length > 0) {
                const w = 1 / pos.length;
                pos.forEach(x => weights[x.k] = w);
            }
        }
        else if (strategy === "DualMom_Rel") {
            const pos = sVals.filter(x => x.val > 0);
            const K = Math.max(1, Math.floor(pos.length / 2));
            if(pos.length > 0) {
                const w = 1 / K;
                for(let i=0; i<K; i++) weights[pos[i].k] = w;
            }
        }
        else if (strategy === "InvVol") {
            let sumInvVol = 0;
            sVals.forEach(x => { if(x.vol > 0) sumInvVol += (1/x.vol); });
            sVals.forEach(x => { if(x.vol > 0) weights[x.k] = (1/x.vol) / sumInvVol; });
        }
        return weights;
    }

    // --- 3. BATCH EXECUTION ---
    async function runBatchEngine() {
        const btn = document.getElementById('btn-run');
        const overlay = document.getElementById('loading-overlay');
        const status = document.getElementById('loading-status');
        
        btn.disabled = true;
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');
        STATE.batchResults = [];

        try {
            // 1. Get Inputs & Parse Batch
            const startDate = document.getElementById('date-start').value;
            const endDate = document.getElementById('date-end').value;
            const strategy = document.getElementById('strategy-select').value;
            
            const lookbackInput = document.getElementById('param-lookback').value;
            const lookbacks = lookbackInput.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x));
            
            const rebalInput = document.getElementById('param-rebal').value;
            const rebalFreqs = rebalInput.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x));

            const tCost = parseFloat(document.getElementById('cost-tcost').value) / 100;
            const expenseRatio = parseFloat(document.getElementById('cost-er').value) / 100;
            const dailyER = expenseRatio / 252;

            // 2. Fetch Data (Once)
            status.innerText = "Fetching Market Data...";
            const rawData = await Promise.all(STATE.assets.map(sym => fetchAssetData(sym, startDate, endDate)));
            
            // Align Data
            let commonDates = rawData[0].map(d=>d.date);
            rawData.forEach(d => {
                if(!d) return;
                const dSet = new Set(d.map(x=>x.date));
                commonDates = commonDates.filter(x => dSet.has(x));
            });
            commonDates.sort();
            
            const prices = [];
            commonDates.forEach(date => {
                let row = { date };
                STATE.assets.forEach((sym, idx) => {
                    const found = rawData[idx]?.find(x=>x.date === date);
                    if(found) row[sym] = found.price;
                });
                prices.push(row);
            });

            // Need max lookback to ensure safety
            const maxLookback = Math.max(...lookbacks);
            if(prices.length < maxLookback + 50) throw new Error("Data too short for max Lookback.");

            // 3. Pre-calc Signals for all Lookbacks
            status.innerText = "Calculating Signals...";
            const assetKeys = STATE.assets;
            const dailyReturns = {};
            const vols = {};
            // For signals, we need to store them by lookback: signals[lookback][asset]
            const signalsByLB = {};

            assetKeys.forEach(sym => {
                const pArr = prices.map(r => r[sym]);
                dailyReturns[sym] = new Array(pArr.length).fill(0);
                for(let i=1; i<pArr.length; i++) dailyReturns[sym][i] = (pArr[i]/pArr[i-1]) - 1;
                vols[sym] = calcVol(dailyReturns[sym], 20); 
            });

            lookbacks.forEach(lb => {
                signalsByLB[lb] = {};
                assetKeys.forEach(sym => {
                    signalsByLB[lb][sym] = calcReturns(prices.map(r=>r[sym]), lb);
                });
            });

            // 4. Batch Loop
            status.innerText = `Running ${lookbacks.length * rebalFreqs.length} Simulations...`;
            
            for(let lb of lookbacks) {
                for(let rb of rebalFreqs) {
                    const res = runSingleSimulation(prices, commonDates, dailyReturns, signalsByLB[lb], vols, lb, rb, dailyER, tCost, strategy, assetKeys);
                    STATE.batchResults.push(res);
                }
            }

            // 5. Select Best
            STATE.batchResults.sort((a,b) => parseFloat(b.stats.sharpe) - parseFloat(a.stats.sharpe));
            
            renderBatchTable();
            viewResult(0); // View Best

            document.getElementById('results-container').classList.remove('hidden');
            document.getElementById('placeholder-viz').classList.add('hidden');
            document.getElementById('history-placeholder').classList.add('hidden');

        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        } finally {
            btn.disabled = false;
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
        }
    }

    function runSingleSimulation(prices, dates, dailyReturns, signals, vols, lookback, rebalFreq, dailyER, tCost, strategy, assetKeys) {
        let valBefore = 1000, valAfter = 1000;
        const curveBefore = [1000], curveAfter = [1000], curveDates = [dates[lookback]];
        let currentWeights = {}; assetKeys.forEach(k => currentWeights[k] = 0);
        let totalTurnover = 0, nRebals = 0;
        const historyLog = [];

        for(let t = lookback; t < prices.length; t++) {
            const isRebalDay = (t - lookback) % rebalFreq === 0;
            
            let dayRetBefore = 0;
            if (t > lookback) {
                assetKeys.forEach(sym => {
                    dayRetBefore += (currentWeights[sym] || 0) * dailyReturns[sym][t];
                });
            }
            const dayRetAfter = dayRetBefore - dailyER;

            valBefore *= (1 + dayRetBefore);
            valAfter *= (1 + dayRetAfter);

            if (isRebalDay) {
                const sigsAtT = {}, volsAtT = {};
                assetKeys.forEach(sym => { sigsAtT[sym] = signals[sym][t]; volsAtT[sym] = vols[sym][t]; });

                const targetWeights = getWeights(strategy, sigsAtT, volsAtT, t, assetKeys);
                
                let turnover = 0;
                assetKeys.forEach(sym => {
                    turnover += Math.abs((targetWeights[sym] || 0) - (currentWeights[sym] || 0));
                });
                
                valAfter *= (1 - (turnover * tCost));
                totalTurnover += turnover;
                nRebals++;
                currentWeights = targetWeights;

                historyLog.push({ date: dates[t], weights: {...targetWeights}, turnover });
            }

            if (t > lookback) {
                curveBefore.push(valBefore);
                curveAfter.push(valAfter);
                curveDates.push(dates[t]);
            }
        }

        const annTurnover = nRebals > 0 ? (totalTurnover / nRebals) * (252/rebalFreq) : 0;
        const stats = calcStats(curveAfter);
        
        return {
            config: { lookback, rebalFreq },
            curveBefore, curveAfter, curveDates,
            stats, annTurnover, historyLog
        };
    }

    // --- 5. UI & CHARTING ---
    function renderBatchTable() {
        const tbody = document.getElementById('batch-table-body');
        tbody.innerHTML = '';
        STATE.batchResults.forEach((res, idx) => {
            const tr = document.createElement('tr');
            tr.className = `batch-row border-b border-slate-100 transition-colors ${idx === 0 ? 'selected' : ''}`;
            tr.onclick = () => viewResult(idx);
            
            // Format metrics
            const isBest = idx === 0 ? 'text-emerald-600 font-bold' : '';
            tr.innerHTML = `
                <td class="p-2 text-left font-mono text-slate-500">${res.config.lookback}</td>
                <td class="p-2 text-left font-mono text-slate-500">${res.config.rebalFreq}</td>
                <td class="p-2 ${parseFloat(res.stats.cagr)>0?'text-emerald-600':'text-rose-500'}">${res.stats.cagr}</td>
                <td class="p-2 ${isBest}">${res.stats.sharpe}</td>
                <td class="p-2 text-rose-500">${res.stats.mdd}</td>
                <td class="p-2 text-slate-400">${(res.annTurnover*100).toFixed(0)}%</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function viewResult(idx) {
        STATE.selectedResultIndex = idx;
        const res = STATE.batchResults[idx];
        
        // Highlight Row
        document.querySelectorAll('.batch-row').forEach(r => r.classList.remove('selected'));
        document.querySelectorAll('.batch-row')[idx].classList.add('selected');

        // Update Stats
        document.getElementById('res-cagr').innerText = res.stats.cagr;
        document.getElementById('res-sharpe').innerText = res.stats.sharpe;
        document.getElementById('res-mdd').innerText = res.stats.mdd;
        document.getElementById('res-turnover').innerText = (res.annTurnover*100).toFixed(1) + "%";

        // Calc Rolling
        const rollingStats = runRollingAnalysis(res.curveAfter, res.curveDates);

        // Render Charts
        renderEquityChart(res.curveDates, res.curveBefore, res.curveAfter);
        renderRollingCharts(rollingStats);
        renderHistoryTable(res.historyLog);
    }

    function renderHistoryTable(log) {
        const table = document.getElementById('history-table');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        
        // Headers
        let headerHTML = `<tr><th class="rounded-tl-lg">Date</th>`;
        STATE.assets.forEach(a => headerHTML += `<th>${a}</th>`);
        headerHTML += `<th class="rounded-tr-lg">Turnover</th></tr>`;
        thead.innerHTML = headerHTML;

        // Rows
        let rowsHTML = "";
        // Show last 50 entries to avoid lag if massive
        const displayLog = log.length > 200 ? log.slice(-200) : log;
        
        displayLog.forEach(entry => {
            rowsHTML += `<tr><td class="font-mono text-slate-500">${entry.date}</td>`;
            STATE.assets.forEach(a => {
                const w = entry.weights[a] || 0;
                const val = (w * 100).toFixed(0);
                const colorClass = w > 0.01 ? "font-bold text-blue-600" : "text-slate-200";
                rowsHTML += `<td class="${colorClass}">${val}%</td>`;
            });
            rowsHTML += `<td class="text-slate-400">${(entry.turnover*100).toFixed(0)}%</td></tr>`;
        });
        tbody.innerHTML = rowsHTML;
    }

    // --- 6. MATH & CHART HELPERS (Standard) ---
    function calcStats(curve) {
        const returns = [];
        for(let i=1; i<curve.length; i++) returns.push((curve[i]/curve[i-1])-1);
        const cagr = (Math.pow(curve[curve.length-1]/curve[0], 252/curve.length) - 1) * 100;
        const mean = returns.reduce((a,b)=>a+b,0)/returns.length;
        const std = Math.sqrt(returns.reduce((a,b)=>a+Math.pow(b-mean,2),0)/(returns.length-1));
        const sharpe = (mean * 252) / (std * Math.sqrt(252));
        let peak = -Infinity, mdd = 0;
        curve.forEach(v => { if(v > peak) peak = v; const dd = (v - peak) / peak; if(dd < mdd) mdd = dd; });
        return { cagr: cagr.toFixed(2)+"%", sharpe: sharpe.toFixed(2), mdd: (mdd*100).toFixed(2)+"%" };
    }

    function runRollingAnalysis(curveVals, dates) {
        const horizons = [1, 3, 5, 10]; const results = {};
        horizons.forEach(years => {
            const days = years * 252;
            const lumpCAGRs = [], dcaCAGRs = [];
            for(let i=0; i < curveVals.length - days; i += 20) {
                const startV = curveVals[i], endV = curveVals[i + days];
                lumpCAGRs.push(Math.pow(endV/startV, 1/years) - 1);
                
                const subCurve = curveVals.slice(i, i+days);
                let units = 0, invested = 0; const monthlyAmt = 1000;
                for(let m=0; m<subCurve.length; m+=21) { units += monthlyAmt / subCurve[m]; invested += monthlyAmt; }
                const finalValue = units * subCurve[subCurve.length-1];
                dcaCAGRs.push(Math.pow(finalValue/invested, 1/years) - 1);
            }
            results[years] = { lump: getDistStats(lumpCAGRs), dca: getDistStats(dcaCAGRs) };
        });
        return results;
    }

    function getDistStats(arr) {
        if(arr.length === 0) return { max:0, min:0, mean:0, median:0, lossProb:0 };
        arr.sort((a,b)=>a-b);
        const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
        const lossCount = arr.filter(x=>x<0).length;
        return { max: arr[arr.length-1], min: arr[0], mean: mean, median: arr[Math.floor(arr.length/2)], lossProb: (lossCount/arr.length) * 100 };
    }

    function renderEquityChart(dates, before, after) {
        const ctx = document.getElementById('chart-equity').getContext('2d');
        if(charts.equity) charts.equity.destroy();
        charts.equity = new Chart(ctx, {
            type: 'line',
            data: { labels: dates, datasets: [
                { label: 'Before Cost', data: before, borderColor: '#10b981', borderWidth: 1, pointRadius: 0 },
                { label: 'After Cost', data: after, borderColor: '#2563eb', borderWidth: 2, pointRadius: 0, backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true }
            ]},
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { type: 'logarithmic' }, x: { ticks: {maxTicksLimit: 8} } }, plugins: { legend: {display: false} } }
        });
    }

    function renderRollingCharts(stats) {
        const years = [1, 3, 5, 10];
        const ctxR = document.getElementById('chart-range').getContext('2d');
        if(charts.range) charts.range.destroy();
        charts.range = new Chart(ctxR, {
            type: 'bar',
            data: { labels: years.map(y => y+"Y"), datasets: [
                { label: 'Lump Max', data: years.map(y=>Math.max(0, stats[y].lump.max*100)), backgroundColor: '#10b981', stack: 'L' },
                { label: 'DCA Max', data: years.map(y=>Math.max(0, stats[y].dca.max*100)), backgroundColor: '#3b82f6', stack: 'D' },
                { label: 'Lump Min', data: years.map(y=>Math.min(0, stats[y].lump.min*100)), backgroundColor: '#ef4444', stack: 'L' },
                { label: 'DCA Min', data: years.map(y=>Math.min(0, stats[y].dca.min*100)), backgroundColor: '#f59e0b', stack: 'D' }
            ]},
            options: { responsive: true, maintainAspectRatio: false }
        });

        const ctxL = document.getElementById('chart-loss').getContext('2d');
        if(charts.loss) charts.loss.destroy();
        charts.loss = new Chart(ctxL, {
            type: 'line',
            data: { labels: years.map(y => y+"Y"), datasets: [
                { label: 'Lump %', data: years.map(y=>stats[y].lump.lossProb), borderColor: '#ef4444', backgroundColor: '#ef4444' },
                { label: 'DCA %', data: years.map(y=>stats[y].dca.lossProb), borderColor: '#3b82f6', backgroundColor: '#3b82f6' }
            ]},
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0 } } }
        });

        const ctxE = document.getElementById('chart-expected').getContext('2d');
        if(charts.expected) charts.expected.destroy();
        charts.expected = new Chart(ctxE, {
            type: 'line',
            data: { labels: years.map(y => y+"Y"), datasets: [
                { label: 'Lump Mean', data: years.map(y=>stats[y].lump.mean*100), borderColor: '#10b981' },
                { label: 'DCA Mean', data: years.map(y=>stats[y].dca.mean*100), borderColor: '#3b82f6' },
                { label: 'Median', data: years.map(y=>stats[y].lump.median*100), borderColor: '#10b981', borderDash:[5,5] }
            ]},
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // UI Helpers
    function renderAssetList() {
        document.getElementById('asset-list').innerHTML = STATE.assets.map((sym, idx) => `
            <div class="flex items-center justify-between bg-slate-50 p-2 rounded border border-slate-100">
                <span class="text-xs font-bold text-slate-700">${sym}</span>
                <button onclick="removeAsset(${idx})" class="text-slate-400 hover:text-rose-500">✕</button>
            </div>`).join('');
    }
    function addAsset() { const sym = prompt("Ticker:"); if(sym) { STATE.assets.push(sym.toUpperCase()); renderAssetList(); } }
    function removeAsset(idx) { STATE.assets.splice(idx, 1); renderAssetList(); }
    function resetDefaultAssets() { STATE.assets = [...DEFAULT_ASSETS]; renderAssetList(); }
    
    function switchTab(t) {
        ['simulator','history','docs'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
        document.getElementById(`view-${t}`).classList.remove('hidden');
        ['sim','hist','docs'].forEach(v => document.getElementById(`tab-${v}`).classList.remove('active'));
        document.getElementById(`tab-${t === 'simulator' ? 'sim' : t === 'history' ? 'hist' : 'docs'}`).classList.add('active');
    }

    // Init
    window.onload = () => {
        const end = new Date(); const start = new Date(); start.setFullYear(end.getFullYear()-8);
        document.getElementById('date-end').valueAsDate = end; document.getElementById('date-start').valueAsDate = start;
        renderAssetList(); updateStrategyDesc();
    }
</script>
</body>
</html>
