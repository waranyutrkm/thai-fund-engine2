<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai Fund Engine v11.6 (Final Fixed & Dual Proxy)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    animation: { 'spin-slow': 'spin 3s linear infinite' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; color: #1e293b; }
        
        .modern-card {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .tab-btn.active { color: #2563eb; border-bottom: 2px solid #2563eb; background-color: #eff6ff; }
        .tab-btn { color: #64748b; padding: 8px 16px; transition: all 0.2s; border-radius: 8px 8px 0 0; }
        .tab-btn:hover { background-color: #f1f5f9; color: #334155; }

        /* Table Styling */
        .rebal-table th { background-color: #f1f5f9; color: #475569; font-weight: 600; font-size: 0.75rem; padding: 10px 8px; text-align: right; cursor: pointer; user-select: none; border-bottom: 2px solid #e2e8f0; }
        .rebal-table th:hover { background-color: #e2e8f0; color: #1e293b; }
        .rebal-table td { border-bottom: 1px solid #e2e8f0; padding: 8px; font-size: 0.75rem; text-align: right; color: #334155; }
        .rebal-table tr:last-child td { border-bottom: none; }
        .rebal-table td:first-child, .rebal-table th:first-child { text-align: left; }
        
        .batch-row:hover { background-color: #f8fafc; cursor: pointer; }
        .batch-row.selected { background-color: #eff6ff; border-left: 4px solid #3b82f6; }

        .info-btn { 
            cursor: pointer; color: #94a3b8; font-size: 0.7rem; margin-left: 4px; vertical-align: middle;
            display: inline-flex; align-items: center; justify-content: center;
            width: 16px; height: 16px; border-radius: 50%; border: 1px solid #cbd5e1;
            transition: all 0.2s; background-color: #fff; font-weight: bold;
        }
        .info-btn:hover { color: #3b82f6; border-color: #3b82f6; background-color: #eff6ff; transform: scale(1.1); }

        .loader {
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #3498db; 
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .th-tooltip { position: relative; }
        .th-tooltip:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: #fff; padding: 4px 8px;
            border-radius: 4px; font-size: 10px; white-space: nowrap; z-index: 50;
            margin-bottom: 4px; white-space: normal; width: 150px; text-align: center;
        }
        
        .pagination-btn {
            padding: 4px 10px; border: 1px solid #e2e8f0; border-radius: 4px; 
            font-size: 0.75rem; color: #64748b; background: white; cursor: pointer;
        }
        .pagination-btn:hover:not(:disabled) { background: #f1f5f9; color: #3b82f6; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Method Docs */
        .doc-section { margin-bottom: 3rem; border-bottom: 1px dashed #e2e8f0; padding-bottom: 2rem; }
        .doc-title { font-size: 1.25rem; font-weight: 700; color: #1e293b; margin-bottom: 1rem; border-left: 4px solid #3b82f6; padding-left: 12px; }
        .doc-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 1.25rem; border-radius: 0.5rem; margin-bottom: 1rem; }
        .stat-val-bench { font-size: 0.75rem; color: #64748b; margin-top: 2px; font-weight: 500; }
        .tag { display: inline-block; padding: 2px 8px; font-size: 0.7rem; font-weight: 600; border-radius: 999px; margin-right: 6px; }
        .tag-blue { background: #dbeafe; color: #1e40af; }
        .tag-green { background: #d1fae5; color: #065f46; }
        .asset-tag { display: inline-flex; align-items: center; background: #e2e8f0; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 4px; margin-bottom: 4px; color: #475569; }
        .asset-remove { margin-left: 6px; cursor: pointer; color: #ef4444; font-weight: bold; }
        .asset-remove:hover { color: #dc2626; }
        
        /* Inspector Modal specific */
        .status-badge { padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 10px; }
        .status-ok { background: #dcfce7; color: #166534; }
        .status-warn { background: #fef9c3; color: #854d0e; }
        .status-err { background: #fee2e2; color: #991b1b; }
        .status-syn { background: #e2e8f0; color: #475569; border: 1px solid #cbd5e1; }
    </style>
</head>

<body class="text-slate-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                    </svg>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight text-slate-800">Thai Fund Engine <span class="text-blue-600">v11.6</span></h1>
                    <p class="text-xs text-slate-500">Fixed & Optimized Core</p>
                </div>
            </div>

            <div class="flex gap-4 items-center">
                <div class="hidden md:flex gap-2 bg-slate-100 p-1 rounded-lg">
                    <button onclick="switchTab('simulator')" id="tab-sim" class="tab-btn active text-xs font-bold">Quant Dashboard</button>
                    <button onclick="switchTab('history')" id="tab-hist" class="tab-btn text-xs font-bold">Allocation Log</button>
                    <button onclick="switchTab('docs')" id="tab-docs" class="tab-btn text-xs font-bold">Methodology</button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-7xl w-full mx-auto px-4 py-8 space-y-8">

        <!-- VIEW 1: DASHBOARD -->
        <div id="view-simulator">
            <div class="flex flex-col lg:flex-row gap-8">
                
                <!-- LEFT PANEL: CONTROLS -->
                <div class="w-full lg:w-1/3 space-y-6">
                    
                    <!-- 1. Strategy Config -->
                    <div class="modern-card p-6 border-t-4 border-t-blue-500">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-2">
                                <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider">1. Strategy Logic</h3>
                                <span class="info-btn" onclick="showInfo('strategy_logic')">?</span>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1.5 block">Rebalance Strategy</label>
                            <div class="relative">
                                <select id="strategy-select" onchange="updateStrategyDesc()" class="w-full bg-slate-50 border border-slate-200 rounded-lg text-xs py-2 px-3 focus:border-blue-500 outline-none appearance-none font-medium text-slate-700">
                                    <optgroup label="Simple Weighting">
                                        <option value="Rank_All">Rank All (Weight by Rank)</option>
                                        <option value="Equal_Weight">Equal Weight (All Assets)</option>
                                    </optgroup>
                                    <optgroup label="Momentum / Top-K">
                                        <option value="Top3_Equal" selected>Top 3 Equal Weight</option>
                                        <option value="Top3_Rank">Top 3 Weighted by Rank</option>
                                        <option value="Top50pct">Top 50% of Universe</option>
                                        <option value="AbsMom">Absolute Momentum (>0)</option>
                                        <option value="DualMom_Rel">Dual Momentum (Relative)</option>
                                    </optgroup>
                                    <optgroup label="Risk Based">
                                        <option value="InvVol">Inverse Volatility</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>

                        <!-- Description Box -->
                        <div id="strat-desc" class="bg-blue-50 border border-blue-100 p-3 rounded-lg text-xs text-blue-800 leading-relaxed mb-4 min-h-[60px]">
                            <!-- JS will update this -->
                        </div>

                        <!-- Benchmark Selector -->
                        <div class="mb-4">
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1.5 block">Benchmark (Compare)</label>
                            <select id="benchmark-select" class="w-full bg-slate-50 border border-slate-200 rounded-lg text-xs py-2 px-3 focus:border-blue-500 outline-none">
                                <option value="">None</option>
                                <option value="EQUAL_WEIGHT">üîπ Equal Weight (Passive)</option>
                                <optgroup label="US Indices">
                                    <option value="SPY">S&P 500 (SPY)</option>
                                    <option value="QQQ">Nasdaq 100 (QQQ)</option>
                                    <option value="VTI">Total US Stock (VTI)</option>
                                    <option value="DIA">Dow Jones (DIA)</option>
                                </optgroup>
                                <optgroup label="Global">
                                    <option value="ACWI">All Country World (ACWI)</option>
                                    <option value="VT">Total World (VT)</option>
                                    <option value="EEM">Emerging Markets (EEM)</option>
                                </optgroup>
                                <optgroup label="Bonds & Alt">
                                    <option value="AGG">US Agg Bond (AGG)</option>
                                    <option value="BND">Total Bond (BND)</option>
                                    <option value="GLD">Gold (GLD)</option>
                                    <option value="BTC-USD">Bitcoin (BTC)</option>
                                </optgroup>
                            </select>
                        </div>

                        <!-- Asset Universe -->
                        <div class="mb-2 flex justify-between items-center">
                            <div class="flex items-center">
                                <label class="text-[10px] font-bold text-slate-500 uppercase">Asset Universe</label>
                                <span class="info-btn" onclick="showInfo('universe')">?</span>
                            </div>
                            <button onclick="resetDefaultAssets()" class="text-[10px] text-blue-500 hover:underline">Reset Default</button>
                        </div>
                        
                        <!-- Quick Add Dropdown -->
                        <div class="relative mb-2">
                            <select id="quick-add-asset" onchange="quickAddAsset(this.value)" class="w-full bg-white border border-dashed border-slate-300 rounded-lg text-xs py-2 px-3 text-slate-500 focus:border-blue-500 outline-none cursor-pointer hover:bg-slate-50">
                                <option value="">+ Add Recommended Asset...</option>
                                <optgroup label="üá∫üá∏ US Equities">
                                    <option value="QQQ">Nasdaq 100 (QQQ)</option>
                                    <option value="SPY">S&P 500 (SPY)</option>
                                    <option value="VTI">Total US Stock (VTI)</option>
                                    <option value="SMH">Semiconductors (SMH)</option>
                                    <option value="NVDA">NVIDIA (NVDA)</option>
                                </optgroup>
                                <optgroup label="üåç Global & Emerging">
                                    <option value="ACWI">All Country World (ACWI)</option>
                                    <option value="VT">Total World (VT)</option>
                                    <option value="EEM">Emerging Markets (EEM)</option>
                                    <option value="INDA">India (INDA)</option>
                                    <option value="CNYA">China A-Shares (CNYA)</option>
                                </optgroup>
                                <optgroup label="üõ°Ô∏è Bonds & Safe Haven">
                                    <option value="TLT">20+ Yr Treasury (TLT)</option>
                                    <option value="AGG">US Agg Bond (AGG)</option>
                                    <option value="GLD">Gold (GLD)</option>
                                    <option value="SLV">Silver (SLV)</option>
                                </optgroup>
                                <optgroup label="üöÄ Alternative">
                                    <option value="BTC-USD">Bitcoin (BTC)</option>
                                    <option value="ETH-USD">Ethereum (ETH)</option>
                                    <option value="DBC">Commodities (DBC)</option>
                                    <option value="UUP">US Dollar (UUP)</option>
                                </optgroup>
                            </select>
                        </div>

                        <div id="asset-list" class="flex flex-wrap gap-2 mb-4 max-h-[150px] overflow-y-auto pr-1"></div>
                        
                        <!-- Manual Add Input -->
                        <div class="flex gap-2 mt-2">
                            <input type="text" id="manual-ticker-input" placeholder="Type Symbol (e.g. TSLA)" class="flex-1 bg-white border border-slate-200 rounded-lg text-xs py-2 px-3 focus:border-blue-500 outline-none uppercase text-slate-700 font-bold" onkeypress="if(event.key==='Enter') addAssetManual()">
                            <button onclick="addAssetManual()" class="px-4 py-2 bg-slate-800 text-white rounded-lg text-xs font-bold hover:bg-slate-700 transition-all shadow-sm">Add</button>
                        </div>
                    </div>

                    <!-- 2. Parameters -->
                    <div class="modern-card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1">
                                2. Execution Parameters
                                <span class="info-btn" onclick="showInfo('exec_params')">?</span>
                            </h3>
                            <span class="text-[10px] text-blue-600 bg-blue-50 px-2 py-1 rounded-full font-bold">Multiple Values OK</span>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-4 mb-4">
                            <div>
                                <div class="flex items-center mb-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase">Lookback (Days)</label>
                                    <span class="info-btn" onclick="showInfo('lookback')">?</span>
                                </div>
                                <input type="text" id="param-lookback" value="60, 120, 252" class="w-full bg-slate-50 border border-slate-200 rounded text-sm p-2 text-slate-700 font-mono placeholder-slate-400" placeholder="e.g. 60, 120, 200">
                                <p class="text-[9px] text-slate-400 mt-1">Comma separated for batch test</p>
                            </div>
                            <div>
                                <div class="flex items-center mb-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase">Rebalance (Days)</label>
                                    <span class="info-btn" onclick="showInfo('rebalance')">?</span>
                                </div>
                                <input type="text" id="param-rebal" value="1, 5, 10, 15, 20" class="w-full bg-slate-50 border border-slate-200 rounded text-sm p-2 text-slate-700 font-mono placeholder-slate-400" placeholder="e.g. 20, 60">
                                <p class="text-[9px] text-slate-400 mt-1">Comma separated for batch test</p>
                            </div>
                        </div>

                        <!-- Analysis Settings -->
                        <div class="mb-4 bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <label class="text-[10px] font-bold text-slate-500 uppercase block mb-2">Rolling Analysis Settings</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <div class="flex items-center mb-1">
                                        <label class="text-[9px] text-slate-400 block">Horizons (Years)</label>
                                        <span class="info-btn" onclick="showInfo('rolling_horizons')">?</span>
                                    </div>
                                    <input type="text" id="param-horizons" value="1, 3, 5, 10, 15" class="w-full bg-white border border-slate-200 rounded text-xs p-1.5 text-slate-700 font-mono">
                                </div>
                                <div>
                                    <div class="flex items-center mb-1">
                                        <label class="text-[9px] text-slate-400 block">Step (Years)</label>
                                        <span class="info-btn" onclick="showInfo('rolling_step')">?</span>
                                    </div>
                                    <input type="number" id="param-roll-step" value="0.2" step="0.1" class="w-full bg-white border border-slate-200 rounded text-xs p-1.5 text-slate-700 font-mono">
                                    <p class="text-[8px] text-slate-400 mt-0.5">Frequency of simulation</p>
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-slate-100 pt-3 mb-4">
                            <div class="flex items-center mb-2">
                                <label class="text-[10px] font-bold text-slate-500 uppercase block">Costs (Reality Check)</label>
                                <span class="info-btn" onclick="showInfo('costs')">?</span>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[10px] text-slate-400 mb-1 flex items-center gap-1">T-Cost (%) <span class="info-btn" onclick="showInfo('t_cost')">?</span></label>
                                    <input type="number" id="cost-tcost" value="0.10" step="0.01" class="w-full bg-slate-50 border border-slate-200 rounded text-sm p-2 text-right text-rose-600 font-medium font-mono">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-400 mb-1 flex items-center gap-1">Ann. Expense (%) <span class="info-btn" onclick="showInfo('expense')">?</span></label>
                                    <input type="number" id="cost-er" value="0.50" step="0.01" class="w-full bg-slate-50 border border-slate-200 rounded text-sm p-2 text-right text-rose-600 font-medium font-mono">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex items-center mb-1.5">
                                <label class="text-[10px] font-bold text-slate-500 uppercase block">Backtest Range</label>
                                <span class="info-btn" onclick="showInfo('range')">?</span>
                            </div>
                            <div class="flex gap-2">
                                <input type="date" id="date-start" class="w-full bg-slate-50 border border-slate-200 rounded-lg text-xs py-2 px-2">
                                <input type="date" id="date-end" class="w-full bg-slate-50 border border-slate-200 rounded-lg text-xs py-2 px-2">
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button id="btn-run" onclick="runBatchEngine()" class="flex-1 bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all">
                                <span>Run Batch Backtest</span>
                            </button>
                            <button onclick="showDataInspector()" class="px-3 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-lg shadow-sm flex items-center justify-center" title="Inspect Raw Data">
                                üîç
                            </button>
                        </div>
                    </div>
                </div>

                <!-- RIGHT PANEL: VISUALIZATION -->
                <div class="w-full lg:w-2/3 space-y-6">
                    
                    <div id="results-container" class="hidden space-y-6">
                        
                        <!-- Batch Summary Table -->
                        <div class="modern-card p-6 border-l-4 border-blue-500">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                        Batch Comparison
                                        <span class="info-btn" onclick="showInfo('batch_comparison')">?</span>
                                    </h2>
                                    <p class="text-xs text-slate-500" id="table-info">Showing top results</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded">Best Sharpe Selected</span>
                                </div>
                            </div>
                            <div class="overflow-x-auto mb-2">
                                <table class="w-full text-xs text-right rebal-table">
                                    <thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-200">
                                        <tr>
                                            <th class="th-tooltip" data-tip="Lookback Period (Days)" onclick="sortTable('lb')">LB ‚Üï</th>
                                            <th class="th-tooltip" data-tip="Rebalance Frequency (Days)" onclick="sortTable('rb')">RB ‚Üï</th>
                                            <th class="th-tooltip" data-tip="Compound Annual Growth Rate" onclick="sortTable('cagr')">CAGR ‚Üï</th>
                                            <th class="th-tooltip" data-tip="Risk-Adjusted Return" onclick="sortTable('sharpe')">Sharpe ‚Üï</th>
                                            <th class="th-tooltip" data-tip="Maximum Drawdown" onclick="sortTable('mdd')">MaxDD ‚Üï</th>
                                            <th class="th-tooltip" data-tip="Portfolio Turnover" onclick="sortTable('turnover')">TO ‚Üï</th>
                                        </tr>
                                    </thead>
                                    <tbody id="batch-table-body" class="text-slate-700"></tbody>
                                </table>
                            </div>
                            <!-- Pagination Controls -->
                            <div class="flex justify-between items-center pt-2 border-t border-slate-100">
                                <button id="btn-prev" onclick="changePage(-1)" class="pagination-btn">Previous</button>
                                <span id="page-indicator" class="text-xs text-slate-500">Page 1</span>
                                <button id="btn-next" onclick="changePage(1)" class="pagination-btn">Next</button>
                            </div>
                        </div>

                        <!-- Selected Result Details -->
                        <div id="single-result-view" class="space-y-6 animate-fade-in">
                            <!-- Key Stats with Benchmark -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="modern-card p-4 border-l-4 border-emerald-500">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1 flex items-center gap-1">CAGR (After Cost) <span class="info-btn" onclick="showInfo('cagr')">?</span></div>
                                    <div id="res-cagr" class="text-2xl font-bold text-emerald-600">-</div>
                                    <div id="bench-cagr" class="stat-val-bench">Bench: -</div>
                                </div>
                                <div class="modern-card p-4">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1 flex items-center gap-1">Sharpe Ratio <span class="info-btn" onclick="showInfo('sharpe')">?</span></div>
                                    <div id="res-sharpe" class="text-2xl font-bold text-blue-600">-</div>
                                    <div id="bench-sharpe" class="stat-val-bench">Bench: -</div>
                                </div>
                                <div class="modern-card p-4">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1 flex items-center gap-1">Max Drawdown <span class="info-btn" onclick="showInfo('mdd')">?</span></div>
                                    <div id="res-mdd" class="text-2xl font-bold text-rose-600">-</div>
                                    <div id="bench-mdd" class="stat-val-bench">Bench: -</div>
                                </div>
                                <div class="modern-card p-4">
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1 flex items-center gap-1">Turnover <span class="info-btn" onclick="showInfo('turnover')">?</span></div>
                                    <div id="res-turnover" class="text-2xl font-bold text-slate-600">-</div>
                                </div>
                            </div>

                            <!-- Main Equity Curve -->
                            <div class="modern-card p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                        Growth Analysis
                                        <span class="info-btn" onclick="showInfo('growth_chart')">?</span>
                                    </h2>
                                    <div class="flex gap-4 text-xs">
                                        <span class="flex items-center gap-1"><span class="w-3 h-3 bg-emerald-500 rounded-full"></span> Strategy</span>
                                        <span class="flex items-center gap-1"><span class="w-3 h-3 bg-slate-400 rounded-full"></span> Benchmark</span>
                                    </div>
                                </div>
                                <div class="h-[300px]">
                                    <canvas id="chart-equity"></canvas>
                                </div>
                            </div>

                            <!-- INVESTOR ANALYSIS -->
                            <div class="bg-slate-50 rounded-xl p-6 border border-slate-200">
                                <div class="text-center mb-6">
                                    <h2 class="text-xl font-bold text-slate-800 flex items-center justify-center gap-2">
                                        Rolling Horizon Analysis (Compare to Benchmark)
                                        <span class="info-btn" onclick="showInfo('rolling_chart')">?</span>
                                    </h2>
                                    <p class="text-sm text-slate-500">‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô "‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ" ‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏ô‡∏∞ Benchmark ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                                </div>
                                
                                <div class="modern-card p-6 mb-6">
                                    <h3 class="text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                                        1. Return Range (Best - Worst Case)
                                        <span class="info-btn" onclick="showInfo('return_range')">?</span>
                                    </h3>
                                    <div class="h-[300px]">
                                        <canvas id="chart-range"></canvas>
                                    </div>
                                </div>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="modern-card p-6">
                                        <h3 class="text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                                            2. Win Probability (>0%)
                                            <span class="info-btn" onclick="showInfo('win_prob')">?</span>
                                        </h3>
                                        <div class="h-[200px]">
                                            <canvas id="chart-loss"></canvas>
                                        </div>
                                    </div>
                                    <div class="modern-card p-6">
                                        <h3 class="text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                                            3. Average Annualized Return
                                            <span class="info-btn" onclick="showInfo('expected_ret')">?</span>
                                        </h3>
                                        <div class="h-[200px]">
                                            <canvas id="chart-expected"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Placeholder -->
                    <div id="placeholder-viz" class="h-96 flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50">
                        <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                        <p class="text-sm font-medium">Configure parameters and Run Batch Analysis</p>
                    </div>

                </div>
            </div>
        </div>

        <!-- VIEW 2: ALLOCATION HISTORY -->
        <div id="view-history" class="hidden max-w-7xl mx-auto space-y-6">
             <div class="modern-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-800">Rebalance History Log</h2>
                    <p class="text-xs text-slate-500">Showing log for selected strategy</p>
                </div>
                <div class="overflow-x-auto rounded-lg border border-slate-200">
                    <table class="w-full rebal-table" id="history-table">
                        <thead class="bg-slate-50">
                            <tr>
                                <th>Date</th>
                                <th>Portfolio Action</th>
                                <th>Turnover</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white" id="history-body">
                            <tr><td colspan="3" class="text-center py-4">Run the simulation to see history</td></tr>
                        </tbody>
                    </table>
                </div>
             </div>
        </div>

        <!-- VIEW 3: METHODOLOGY (Docs) -->
        <div id="view-docs" class="hidden max-w-4xl mx-auto my-8 space-y-8 animate-fade-in">
             <div class="doc-section">
                <h2 class="doc-title">1. ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö (System Workflow)</h2>
                <p class="doc-text mb-4 text-sm text-slate-600 leading-relaxed">
                    ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (Historical Data) ‡∏ú‡∏™‡∏°‡∏ú‡∏™‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå (Quantitative Logic) ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
                </p>
                <div class="doc-box">
                    <ol class="list-decimal list-inside space-y-3 text-sm text-slate-600">
                        <li><strong>Data Fetching:</strong> ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß (Adjusted Close) ‡∏à‡∏≤‡∏Å Yahoo Finance ‡∏ú‡πà‡∏≤‡∏ô Proxy (AllOrigins ‡∏´‡∏£‡∏∑‡∏≠ CORSProxy) ‡∏´‡∏≤‡∏Å‡∏î‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á (Synthetic Data) ‡πÅ‡∏ó‡∏ô</li>
                        <li><strong>Signal Calculation:</strong> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤ Momentum ‡∏´‡∏£‡∏∑‡∏≠ Volatility ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≤‡∏° Lookback ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</li>
                        <li><strong>Allocation:</strong> ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö Rebalance ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå</li>
                        <li><strong>Backtest:</strong> ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô ‡πÇ‡∏î‡∏¢‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á (Cost) ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</li>
                    </ol>
                </div>
             </div>
        </div>

    </main>

    <!-- Info Modal -->
    <div id="info-modal" class="fixed inset-0 z-[100] bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4" onclick="if(event.target===this) closeInfo()">
        <div class="bg-white p-6 max-w-md w-full rounded-2xl shadow-xl transform transition-all scale-100">
            <h3 id="info-title" class="text-lg font-bold text-blue-700 mb-3 border-b pb-2">Title</h3>
            <div id="info-desc" class="text-sm text-slate-600 leading-relaxed mb-6 font-light">Description</div>
            <button onclick="closeInfo()" class="w-full py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-lg transition-colors">Close</button>
        </div>
    </div>

    <!-- Data Inspector Modal -->
    <div id="inspector-modal" class="fixed inset-0 z-[100] bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4" onclick="if(event.target===this) closeInspector()">
        <div class="bg-white p-6 max-w-2xl w-full rounded-2xl shadow-xl transform transition-all scale-100 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    üîç Data Inspector
                </h3>
                <button onclick="closeInspector()" class="text-slate-400 hover:text-slate-600 font-bold text-xl">√ó</button>
            </div>
            <div class="overflow-y-auto flex-1">
                <table class="w-full text-xs text-right border-collapse">
                    <thead class="bg-slate-100 text-slate-600 font-bold sticky top-0">
                        <tr>
                            <th class="p-2 text-left">Asset</th>
                            <th class="p-2">Count</th>
                            <th class="p-2">Start Price</th>
                            <th class="p-2">End Price</th>
                            <th class="p-2">Max Gap</th>
                            <th class="p-2">Status</th>
                        </tr>
                    </thead>
                    <tbody id="inspector-body" class="text-slate-700">
                        <tr><td colspan="6" class="p-4 text-center">No data loaded. Run backtest first.</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 pt-2 border-t text-xs text-slate-400">
                Tip: Status <span class="text-rose-600">RED</span> means error, <span class="status-syn">SYNTHETIC</span> means fake data used.
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[60] bg-white/90 backdrop-blur-sm hidden flex-col items-center justify-center">
        <div class="loader mb-4 border-t-blue-500"></div>
        <div class="text-lg font-bold text-slate-700">Calculating...</div>
        <div id="loading-status" class="text-sm text-slate-500 mt-2">Preparing data engine</div>
    </div>

<script>
    // --- CONFIG & STATE ---
    const DEFAULT_ASSETS = ["QQQ", "SPY", "TLT", "GLD", "DBC", "UUP"];
    let STATE = {
        assets: [...DEFAULT_ASSETS],
        batchResults: [],
        selectedResultIndex: 0,
        benchmarkData: null,
        benchmarkStats: null,
        currentPage: 1,
        rowsPerPage: 20, 
        sortCol: 'sharpe',
        sortAsc: false,
        dataInspectionReport: [] // New state for data check
    };
    let charts = {};

    // --- TEXTS ---
    const STRAT_DESCS = {
        "Rank_All": "‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡∏ó‡∏µ‡πà 1 ‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î)",
        "Equal_Weight": "‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ó‡πà‡∏≤‡πÜ ‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå (Passive)",
        "Top3_Equal": "‡∏Ñ‡∏±‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 3 ‡∏ï‡∏±‡∏ß‡∏ó‡πá‡∏≠‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞ 33.3%",
        "Top3_Rank": "‡∏Ñ‡∏±‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 3 ‡∏ï‡∏±‡∏ß‡∏ó‡πá‡∏≠‡∏õ ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á (Rank)",
        "Top50pct": "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô",
        "AbsMom": "‡∏ñ‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô (Trend > 0) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô‡∏•‡∏á‡∏Ç‡∏≤‡∏¢‡∏ó‡∏¥‡πâ‡∏á",
        "DualMom_Rel": "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢",
        "InvVol": "‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢: ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡∏ï‡πà‡∏≥ (Low Risk)"
    };
    const INFO_TEXTS = {
        "strategy_logic": "<b>Strategy Logic</b> ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≠‡∏ö (Rebalance) ‡∏à‡∏∞‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô ‡∏Ç‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô<br><br>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 8 ‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Methodology",
        "universe": "<b>Asset Universe</b> ‡∏Ñ‡∏∑‡∏≠ '‡∏ï‡∏£‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå' ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∏‡∏ô",
        "exec_params": "<b>Execution Parameters</b> ‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡πÉ‡∏™‡πà‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (Grid Search)",
        "lookback": "<b>Lookback (‡∏ß‡∏±‡∏ô)</b>: ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏°‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á (Momentum) <br>‡πÄ‡∏ä‡πà‡∏ô 60 ‡∏ß‡∏±‡∏ô = ‡∏î‡∏π‡∏ú‡∏•‡∏á‡∏≤‡∏ô 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á <br>- ‡∏™‡∏±‡πâ‡∏ô: ‡πÑ‡∏ß‡∏ï‡πà‡∏≠‡∏ï‡∏•‡∏≤‡∏î ‡πÅ‡∏ï‡πà Noise ‡πÄ‡∏¢‡∏≠‡∏∞ <br>- ‡∏¢‡∏≤‡∏ß: ‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡πÅ‡∏ï‡πà‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏•‡∏≤‡∏î",
        "rebalance": "<b>Rebalance (‡∏ß‡∏±‡∏ô)</b>: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏≠‡∏£‡πå‡∏ï <br>‡πÄ‡∏ä‡πà‡∏ô 20 ‡∏ß‡∏±‡∏ô = ‡∏õ‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <br>- ‡∏ñ‡∏µ‡πà: ‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏™‡∏î‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø <br>- ‡∏´‡πà‡∏≤‡∏á: ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î ‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏ä‡πâ‡∏≤",
        "costs": "<b>Costs</b>: ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÅ‡∏ù‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á (‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø + ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô)",
        "t_cost": "<b>T-Cost (%)</b>: Transaction Cost ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡∏ô+Slippage ‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á",
        "expense": "<b>Expense Ratio (%)</b>: ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏£‡∏≤‡∏¢‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô ETF ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô",
        "batch_comparison": "<b>Batch Comparison</b>: ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏∏‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö)",
        "cagr": "<b>CAGR (%)</b>: ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏ó‡∏ö‡∏ï‡πâ‡∏ô‡∏ï‡πà‡∏≠‡∏õ‡∏µ (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢)",
        "sharpe": "<b>Sharpe Ratio</b>: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (>1 ‡∏î‡∏µ)",
        "mdd": "<b>Max Drawdown (%)</b>: ‡∏ú‡∏•‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏î‡∏≠‡∏¢ (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏à‡πá‡∏ö‡∏õ‡∏ß‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)",
        "turnover": "<b>Turnover (%)</b>: ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏ï‡πà‡∏≠‡∏õ‡∏µ ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏ö‡πà‡∏≠‡∏¢‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô",
        "growth_chart": "‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô 1,000 ‡∏ö‡∏≤‡∏ó (‡πÅ‡∏Å‡∏ô Y ‡πÅ‡∏ö‡∏ö Log Scale) ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö Benchmark",
        "rolling_chart": "‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ã‡πâ‡∏≥‡πÜ ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏≠‡∏î‡∏µ‡∏ï ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ú‡∏¥‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£",
        "return_range": "‡∏Å‡∏£‡∏≠‡∏ö‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î/‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î (‡πÅ‡∏ó‡πà‡∏á‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏Ñ‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô)",
        "win_prob": "<b>Win Probability (%)</b>: ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡πÑ‡∏£ (>0) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡∏¢‡∏¥‡πà‡∏á‡∏ñ‡∏∑‡∏≠‡∏ô‡∏≤‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ä‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏£‡∏¢‡∏¥‡πà‡∏á‡∏™‡∏π‡∏á",
        "expected_ret": "<b>Expected Return</b>: ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (Mean vs Median) DCA ‡∏°‡∏±‡∏Å‡πÑ‡∏î‡πâ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ Lump Sum ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡∏Å‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤",
        "rolling_horizons": "‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏õ‡∏µ)",
        "rolling_step": "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô (‡∏ß‡∏±‡∏ô)"
    };

    // --- UI HELPERS ---
    function updateStrategyDesc() { document.getElementById('strat-desc').innerText = STRAT_DESCS[document.getElementById('strategy-select').value] || ""; }
    function showInfo(k) { 
        document.getElementById('info-title').innerText = k.replace('_',' ').toUpperCase();
        document.getElementById('info-desc').innerHTML = INFO_TEXTS[k] || "No desc";
        document.getElementById('info-modal').classList.remove('hidden'); document.getElementById('info-modal').classList.add('flex');
    }
    function closeInfo() { document.getElementById('info-modal').classList.add('hidden'); document.getElementById('info-modal').classList.remove('flex'); }
    function getVal(id) { const el=document.getElementById(id); return el?el.value:""; }
    function switchTab(t) { 
        ['simulator','history','docs'].forEach(v=>document.getElementById(`view-${v}`).classList.add('hidden'));
        document.getElementById(`view-${t}`).classList.remove('hidden');
        ['sim','hist','docs'].forEach(v=>document.getElementById(`tab-${v}`).classList.remove('active'));
        document.getElementById(`tab-${t==='simulator'?'sim':t==='history'?'hist':'docs'}`).classList.add('active');
    }
    function showEl(id) { const el = document.getElementById(id); if(el) el.classList.remove('hidden'); }
    function hideEl(id) { const el = document.getElementById(id); if(el) el.classList.add('hidden'); }
    
    // --- INSPECTOR HELPERS ---
    function showDataInspector() {
        const modal = document.getElementById('inspector-modal');
        const tbody = document.getElementById('inspector-body');
        modal.classList.remove('hidden'); modal.classList.add('flex');
        
        tbody.innerHTML = '';
        if(!STATE.dataInspectionReport || STATE.dataInspectionReport.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center">No data loaded yet.</td></tr>';
            return;
        }
        
        STATE.dataInspectionReport.forEach(r => {
            let statusClass = 'status-ok';
            if(r.status.includes('ERR')) statusClass = 'status-err';
            else if(r.status.includes('WARN')) statusClass = 'status-warn';
            else if(r.status.includes('SYNTHETIC')) statusClass = 'status-syn';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="p-2 text-left font-bold border-b border-slate-100">${r.asset}</td>
                <td class="p-2 border-b border-slate-100">${r.count}</td>
                <td class="p-2 border-b border-slate-100">${r.startP}</td>
                <td class="p-2 border-b border-slate-100">${r.endP}</td>
                <td class="p-2 border-b border-slate-100">${r.maxGap}d</td>
                <td class="p-2 border-b border-slate-100"><span class="status-badge ${statusClass}">${r.status}</span></td>
            `;
            tbody.appendChild(tr);
        });
    }
    function closeInspector() { document.getElementById('inspector-modal').classList.add('hidden'); document.getElementById('inspector-modal').classList.remove('flex'); }

    // --- ASSET MANAGEMENT ---
    function renderAssetList() {
        const c = document.getElementById('asset-list'); c.innerHTML='';
        STATE.assets.forEach(a => {
            c.innerHTML += `<span class="asset-tag">${a} <span class="asset-remove" onclick="removeAsset('${a}')">√ó</span></span>`;
        });
    }
    function addAssetManual() {
        const v = document.getElementById('manual-ticker-input').value.trim().toUpperCase();
        if(v && !STATE.assets.includes(v)) { STATE.assets.push(v); renderAssetList(); }
        document.getElementById('manual-ticker-input').value = '';
    }
    function quickAddAsset(v) { if(v && !STATE.assets.includes(v)) { STATE.assets.push(v); renderAssetList(); } document.getElementById('quick-add-asset').value = ""; }
    function removeAsset(v) { STATE.assets = STATE.assets.filter(a=>a!==v); renderAssetList(); }
    function resetDefaultAssets() { STATE.assets = [...DEFAULT_ASSETS]; renderAssetList(); }

    // --- CORE LOGIC ---
    function generateSyntheticData(days, startPrice=100) {
        let p=startPrice, d=new Date(); d.setDate(d.getDate()-days);
        const arr=[]; 
        for(let i=0; i<days; i++) {
            d.setDate(d.getDate()+1);
            if(d.getDay()===0||d.getDay()===6) continue;
            p *= (1 + (Math.random()-0.45)*0.02); // Slight upward drift
            arr.push({date:d.toISOString().split('T')[0], price:p});
        }
        return arr;
    }

    async function fetchAssetData(sym, start, end) {
        const p1=Math.floor(new Date(start).getTime()/1000), p2=Math.floor(new Date(end).getTime()/1000);
        // Proxies
        const pxy1 = (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`;
        const pxy2 = (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`;
        const url=`https://query1.finance.yahoo.com/v8/finance/chart/${sym}?period1=${p1}&period2=${p2}&interval=1d&includeAdjustedClose=true`;
        
        // Helper to parse Yahoo JSON
        const parseY = async (res) => {
            if(!res.ok) throw new Error("Net Error");
            const j=await res.json();
            const r=j.chart.result?.[0];
            if(!r) throw new Error("No data");
            const adj = r.indicators.adjclose?.[0].adjclose;
            if(!adj) throw new Error("No adj close");
            return r.timestamp.map((t,i)=>({
                date:new Date(t*1000).toISOString().split('T')[0], 
                price: adj[i]
            })).filter(x=>x.price !== null && x.price !== undefined);
        };

        try {
            // Try Proxy 1
            const res1 = await fetch(pxy1(url));
            const data = await parseY(res1);
            data._source = "REAL (P1)";
            return data;
        } catch(e1) {
            console.warn(`Proxy 1 failed for ${sym}, trying Proxy 2...`);
            try {
                // Try Proxy 2
                const res2 = await fetch(pxy2(url));
                const data = await parseY(res2);
                data._source = "REAL (P2)";
                return data;
            } catch(e2) {
                 console.warn(`All proxies failed for ${sym}: ${e2.message}`);
                 const days = Math.ceil(Math.abs(new Date(end)-new Date(start))/(1000*60*60*24));
                 const synth = generateSyntheticData(days);
                 synth._source = "SYNTHETIC";
                 return synth;
            }
        }
    }

    function calcReturns(p, lb) {
        const r=new Array(p.length).fill(NaN);
        for(let i=lb; i<p.length; i++) {
            const prev = p[i-lb];
            if(prev && prev !== 0) r[i] = (p[i]/prev) - 1;
            else r[i] = 0;
        }
        return r;
    }
    function calcVol(dr, lb) {
        const r=new Array(dr.length).fill(NaN);
        for(let i=lb; i<dr.length; i++) {
            const w=dr.slice(i-lb+1, i+1);
            if(w.length < 2) { r[i] = 0; continue; }
            const m=w.reduce((a,b)=>a+b,0)/w.length;
            r[i] = Math.sqrt(w.reduce((a,b)=>a+Math.pow(b-m,2),0)/(w.length-1));
        }
        return r;
    }
    function getWeights(strat, sig, vol, keys) {
        const active = keys.filter(k=>!isNaN(sig[k]));
        if(!active.length) return {};
        // Prepare items
        const items = active.map(k=>({k, val:sig[k], vol:vol[k] || 0}));
        // Sort by Signal Desc
        items.sort((a,b)=>b.val-a.val);
        
        let w={}; keys.forEach(k=>w[k]=0);
        
        if(strat==="Rank_All") { 
            const N=items.length, S=(N*(N+1))/2; 
            items.forEach((x,i)=>w[x.k]=(N-i)/S); 
        }
        else if(strat==="Equal_Weight") { 
            items.forEach(x=>w[x.k]=1/items.length); 
        }
        else if(strat==="Top3_Equal") { 
            const K=Math.min(3,items.length); 
            for(let i=0;i<K;i++) w[items[i].k]=1/K; 
        }
        else if(strat==="Top3_Rank") { 
            const K=Math.min(3,items.length), S=(K*(K+1))/2; 
            for(let i=0;i<K;i++) w[items[i].k]=(K-i)/S; 
        }
        else if(strat==="Top50pct") { 
            const K=Math.max(1,Math.floor(items.length/2)); 
            for(let i=0;i<K;i++) w[items[i].k]=1/K; 
        }
        else if(strat==="AbsMom") { 
            const p=items.filter(x=>x.val>0); 
            if(p.length) p.forEach(x=>w[x.k]=1/p.length); 
        }
        else if(strat==="DualMom_Rel") { 
            const p=items.filter(x=>x.val>0), K=Math.max(1,Math.floor(p.length/2)); 
            if(p.length) for(let i=0;i<K;i++) w[p[i].k]=1/K; 
        }
        else if(strat==="InvVol") { 
            let S=0; 
            items.forEach(x=>{ if(x.vol>0) S+=1/x.vol; }); 
            if(S>0) items.forEach(x=>{ if(x.vol>0) w[x.k]=(1/x.vol)/S; });
            else items.forEach(x=>w[x.k]=1/items.length); // Fallback if vol 0
        }
        return w;
    }

    function calcStats(c) {
        const r = [];
        for (let i = 1; i < c.length; i++) r.push(c[i] / c[i - 1] - 1);
        if (r.length === 0) return { cagr: "0.00", sharpe: "0.00", mdd: "0.00" };

        const cagr = (Math.pow(c[c.length - 1] / c[0], 252 / c.length) - 1) * 100;
        
        const mean = r.reduce((a, b) => a + b, 0) / r.length;
        const std = Math.sqrt(r.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / (r.length - 1));
        const sharpe = std > 0 ? (mean / std) * Math.sqrt(252) : 0; 

        let peak = -Infinity;
        let mdd = 0;
        for (let v of c) {
            if (v > peak) peak = v;
            const dd = (v - peak) / peak;
            if (dd < mdd) mdd = dd;
        }

        return {
            cagr: cagr.toFixed(2),
            sharpe: sharpe.toFixed(2),
            mdd: (mdd * 100).toFixed(2)
        };
    }
    
    // --- DATA INSPECTOR LOGIC ---
    function inspectData(assets, rawPrices) {
        const report = [];
        assets.forEach((asset, idx) => {
            const data = rawPrices[idx];
            let status = "OK";
            let maxGap = 0;
            
            if(!data || data.length === 0) {
                report.push({ asset, count: 0, startP: "-", endP: "-", maxGap: "-", status: "ERR: No Data" });
                return;
            }

            // Check Source
            if(data._source === "SYNTHETIC") {
                status = "WARN: SYNTHETIC (FAKE)";
            }

            // Check zeros / NaNs
            const hasZero = data.some(d => d.price <= 0.0001 || isNaN(d.price));
            if(hasZero) status = "ERR: Price=0";

            // Check gaps
            for(let i=1; i<data.length; i++) {
                const d1 = new Date(data[i-1].date);
                const d2 = new Date(data[i].date);
                const diff = (d2-d1)/(1000*3600*24);
                if(diff > maxGap) maxGap = diff;
                
                // Check volatility > 20% in 1 day
                const change = Math.abs(data[i].price/data[i-1].price - 1);
                if(change > 0.30 && !status.includes("SYNTHETIC")) status = status==="OK" ? "WARN: Vol>30%" : status;
            }
            
            if(maxGap > 10 && !status.includes("SYNTHETIC")) status = status==="OK" ? "WARN: Gap>10d" : status;

            report.push({
                asset,
                count: data.length,
                startP: data[0].price.toFixed(2),
                endP: data[data.length-1].price.toFixed(2),
                maxGap: maxGap.toFixed(1),
                status
            });
        });
        STATE.dataInspectionReport = report;
    }

    async function runBatchEngine() {
        const btn=document.getElementById('btn-run'), over=document.getElementById('loading-overlay'), status=document.getElementById('loading-status');
        if(btn) btn.disabled=true; 
        if(over) { over.classList.remove('hidden'); over.classList.add('flex'); }
        STATE.batchResults=[];

        try {
            const start=getVal('date-start'), end=getVal('date-end');
            const lbs=getVal('param-lookback').split(',').map(x=>parseInt(x.trim())).filter(x=>!isNaN(x));
            const rbs=getVal('param-rebal').split(',').map(x=>parseInt(x.trim())).filter(x=>!isNaN(x));
            const tcost=parseFloat(getVal('cost-tcost'))/100;
            const er=parseFloat(getVal('cost-er'))/100/252; // Daily ER
            const strat=document.getElementById('strategy-select').value;
            const benchSym=document.getElementById('benchmark-select').value;
            const horizons = getVal('param-horizons').split(',').map(x=>parseInt(x.trim())).filter(x=>!isNaN(x));
            const rollStepYears = parseFloat(getVal('param-roll-step')) || 0.1;
            const rollStep = Math.max(1, Math.floor(rollStepYears * 252));

            // Fetch Data
            status.innerText="Fetching Asset Data...";
            const raw = await Promise.all(STATE.assets.map(s=>fetchAssetData(s, start, end)));
            
            // --- DATA INSPECTION STEP ---
            inspectData(STATE.assets, raw);
            
            // Align Data (Intersection of dates)
            // To simplify, we take the dates from the first asset and map others. 
            // In a pro system, we'd do a proper merge join.
            let dates = raw[0].map(d=>d.date); 
            // Filter common dates if needed, but here we assume Yahoo returns mostly aligned days or we fill fwd
            // Let's just use the first asset's dates as master for simplicity
            
            const prices = [];
            dates.forEach(d => {
                let row={date:d}; 
                STATE.assets.forEach((s,i)=>{ 
                    const f=raw[i].find(x=>x.date===d); 
                    if(f) row[s]=f.price; 
                });
                // Simple Fill Forward if missing
                STATE.assets.forEach(s => {
                   if(!row[s] && prices.length>0) row[s] = prices[prices.length-1][s];
                });
                // Only push if we have data for all (or fill fwd worked)
                if(STATE.assets.every(k=>row[k]!==undefined)) prices.push(row);
            });
            
            // Re-update dates to matched prices
            dates = prices.map(p=>p.date);

            // Benchmark
            STATE.benchmarkData = null;
            if(benchSym && benchSym!=="EQUAL_WEIGHT") {
                const bRaw = await fetchAssetData(benchSym, start, end);
                STATE.benchmarkData = dates.map(d=> {
                    const f = bRaw.find(x=>x.date===d);
                    return f ? f.price : (bRaw[bRaw.length-1]?.price || 100); // fallback
                });
            }

            // Pre-Calc Daily Returns & Volatility
            status.innerText="Calculating Indicators...";
            const daily={}, vols={}, sigs={};
            STATE.assets.forEach(s => {
                const p = prices.map(r=>r[s]);
                daily[s] = new Array(p.length).fill(0);
                for(let i=1;i<p.length;i++) {
                    const prev = p[i-1];
                    daily[s][i] = (prev && prev !== 0) ? (p[i]/prev - 1) : 0;
                }
                vols[s] = calcVol(daily[s], 20); // 20-day vol standard
            });
            
            // Pre-Calc Signals for all Lookbacks
            lbs.forEach(lb => {
                sigs[lb]={}; 
                STATE.assets.forEach(s => sigs[lb][s] = calcReturns(prices.map(r=>r[s]), lb));
            });

            // Sim Loop
            status.innerText="Running Simulations...";
            for(let lb of lbs) {
                for(let rb of rbs) {
                    let va=1000, ca=[1000], w={}, totTO=0, nRb=0, log=[];
                    STATE.assets.forEach(k=>w[k]=0);
                    
                    const startIdx = Math.max(lb, 20); 
                    if(startIdx >= prices.length) continue;

                    for(let t=startIdx; t<prices.length; t++) {
                        // 1. Calculate Daily Return of Portfolio based on yesterday's weights
                        let dr=0; 
                        STATE.assets.forEach(k=>dr+=w[k]*(daily[k][t]||0));
                        if(isNaN(dr)) dr=0;
                        
                        // Apply Return and Expense Ratio
                        va *= (1 + dr - er);

                        // 2. Rebalance Logic
                        if((t-startIdx) % rb === 0) {
                            const sT={}, vT={}; 
                            STATE.assets.forEach(k=>{ sT[k]=sigs[lb][k][t]||0; vT[k]=vols[k][t]||0; });
                            
                            const tw = getWeights(strat, sT, vT, STATE.assets);
                            
                            // Calc Turnover Cost
                            let to=0; 
                            STATE.assets.forEach(k=>to+=Math.abs((tw[k]||0)-(w[k]||0)));
                            // One-way turnover sum is 200% max (sell all, buy all). 
                            // T-cost applies to total volume traded. 
                            // Simplification: turnover * tcost / 2 (since to counts sell+buy diffs? No, |w_new - w_old| sums to 2 max. 
                            // We pay tcost on the traded amount. Traded amount = sum(|diff|) / 2 ? No, sum(|diff|) is total volume moved.
                            // If I sell 50% A to buy 50% B, diff is 0.5 + 0.5 = 1.0. I traded 50% of portfolio.
                            // So va *= (1 - (to/2) * tcost). Let's be conservative and use full TO sum as proxy for "impact". 
                            // Actually standard is: va -= va * sum(|diff|) * cost_rate.
                            // Note: sum(|diff|) counts both buy and sell legs.
                            
                            // Let's use: Cost = (Sum(|diff|) / 2) * TCost * 2? No, just Sum(|diff|) * Tcost/2 (one way?)
                            // Let's stick to standard conservative: Cost = Sum(|diff|) * TCost
                            const costAmt = to * tcost; 
                            va *= (1 - costAmt);

                            totTO += to; 
                            nRb++; 
                            w = tw;
                            
                            // Log
                            const activeHoldings = Object.entries(w).filter(([k,v])=>v>0.01).map(([k,v])=>`${k}:${Math.round(v*100)}%`).join(', ');
                            log.push({
                                date: dates[t], 
                                action: activeHoldings || "Cash/None", 
                                turnover: (to*100).toFixed(1)+"%"
                            });
                        }
                        ca.push(va);
                    }
                    
                    const stats = calcStats(ca);
                    // Annualized Turnover
                    const years = (prices.length - startIdx) / 252;
                    const annTO = years > 0 ? ((totTO / 2) / years) * 100 : 0; // /2 because 200% turnover = 100% rotation
                    
                    // Benchmark Curve Generation
                    let benchCurve = null;
                    if(STATE.benchmarkData) {
                        const base = STATE.benchmarkData[startIdx] || 1;
                        benchCurve = STATE.benchmarkData.slice(startIdx).map(v => (v/base)*1000);
                    } else if (benchSym === "EQUAL_WEIGHT") {
                        let bc = [1000], bv=1000;
                        for(let t=startIdx; t<prices.length; t++) {
                            let dr=0; STATE.assets.forEach(k=>dr+=(1/STATE.assets.length)*(daily[k][t]||0));
                            bv *= (1+dr); bc.push(bv);
                        }
                        benchCurve = bc;
                    }

                    STATE.batchResults.push({ 
                        config:{lb, rb}, 
                        curve:ca, 
                        dates: dates.slice(startIdx), 
                        stats, 
                        annTO: annTO.toFixed(0), 
                        log, 
                        benchCurve,
                        benchStats: benchCurve ? calcStats(benchCurve) : null,
                        rollSettings: { horizons, rollStep }
                    });
                }
            }
            
            STATE.batchResults.sort((a,b)=>parseFloat(b.stats.sharpe)-parseFloat(a.stats.sharpe));
            
            // Render
            renderBatchTable();
            viewResult(0);
            
            showEl('results-container');
            hideEl('placeholder-viz');

        } catch(e) { 
            alert("Simulation Error: " + e.message); 
            console.error(e); 
        } finally { 
            if(btn) btn.disabled=false; 
            if(over) { over.classList.add('hidden'); over.classList.remove('flex'); } 
        }
    }

    // --- VISUALIZATION & TABLES ---
    function renderBatchTable() {
        const tbody = document.getElementById('batch-table-body');
        tbody.innerHTML = '';
        
        const start = (STATE.currentPage - 1) * STATE.rowsPerPage;
        const end = start + STATE.rowsPerPage;
        const subset = STATE.batchResults.slice(start, end);
        
        document.getElementById('page-indicator').innerText = `Page ${STATE.currentPage} of ${Math.ceil(STATE.batchResults.length/STATE.rowsPerPage)}`;
        document.getElementById('btn-prev').disabled = STATE.currentPage === 1;
        document.getElementById('btn-next').disabled = end >= STATE.batchResults.length;

        subset.forEach((r, i) => {
            const globalIdx = start + i;
            const tr = document.createElement('tr');
            tr.className = `batch-row transition-all ${globalIdx===STATE.selectedResultIndex ? 'selected' : ''}`;
            tr.onclick = () => viewResult(globalIdx);
            tr.innerHTML = `
                <td class="font-mono text-slate-500">${r.config.lb}</td>
                <td class="font-mono text-slate-500">${r.config.rb}</td>
                <td class="font-bold ${parseFloat(r.stats.cagr)>0?'text-emerald-600':'text-rose-600'}">${r.stats.cagr}%</td>
                <td class="font-bold text-blue-600">${r.stats.sharpe}</td>
                <td class="text-rose-600">${r.stats.mdd}%</td>
                <td class="text-slate-500">${r.annTO}%</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function sortTable(col) {
        if(STATE.sortCol === col) STATE.sortAsc = !STATE.sortAsc;
        else { STATE.sortCol = col; STATE.sortAsc = false; } // Default desc
        
        STATE.batchResults.sort((a,b) => {
            let vA, vB;
            if(col==='lb') { vA=a.config.lb; vB=b.config.lb; }
            else if(col==='rb') { vA=a.config.rb; vB=b.config.rb; }
            else if(col==='turnover') { vA=parseFloat(a.annTO); vB=parseFloat(b.annTO); }
            else { vA=parseFloat(a.stats[col]); vB=parseFloat(b.stats[col]); }
            return STATE.sortAsc ? vA-vB : vB-vA;
        });
        renderBatchTable();
    }
    
    function changePage(d) {
        STATE.currentPage += d;
        renderBatchTable();
    }

    function viewResult(idx) {
        STATE.selectedResultIndex = idx;
        const res = STATE.batchResults[idx];
        
        // Highlight row
        const rows = document.querySelectorAll('.batch-row');
        rows.forEach(r => r.classList.remove('selected'));
        // Re-render table to ensure highlight if on current page
        renderBatchTable();

        // Update Stats
        document.getElementById('res-cagr').innerText = res.stats.cagr + "%";
        document.getElementById('res-sharpe').innerText = res.stats.sharpe;
        document.getElementById('res-mdd').innerText = res.stats.mdd + "%";
        document.getElementById('res-turnover').innerText = res.annTO + "%";

        if(res.benchStats) {
            document.getElementById('bench-cagr').innerText = `Bench: ${res.benchStats.cagr}%`;
            document.getElementById('bench-sharpe').innerText = `Bench: ${res.benchStats.sharpe}`;
            document.getElementById('bench-mdd').innerText = `Bench: ${res.benchStats.mdd}%`;
        } else {
            ['cagr','sharpe','mdd'].forEach(k=>document.getElementById(`bench-${k}`).innerText = "Bench: -");
        }

        // Charts
        renderEquityChart(res);
        renderRollingCharts(res);

        // History Table
        const hBody = document.getElementById('history-body');
        hBody.innerHTML = '';
        // Show last 50 entries
        res.log.slice().reverse().forEach(l => {
            hBody.innerHTML += `<tr><td>${l.date}</td><td>${l.action}</td><td>${l.turnover}</td></tr>`;
        });
    }

    // --- CHART RENDERING ---
    function destroyChart(id) { if(charts[id]) { charts[id].destroy(); charts[id]=null; } }

    function renderEquityChart(res) {
        destroyChart('chart-equity');
        const ctx = document.getElementById('chart-equity').getContext('2d');
        
        const datasets = [{
            label: 'Strategy Equity',
            data: res.curve,
            borderColor: '#059669', // Emerald 600
            backgroundColor: 'rgba(5, 150, 105, 0.1)',
            borderWidth: 2,
            pointRadius: 0,
            fill: true
        }];

        if(res.benchCurve) {
            datasets.push({
                label: 'Benchmark',
                data: res.benchCurve,
                borderColor: '#94a3b8', // Slate 400
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false
            });
        }

        charts['chart-equity'] = new Chart(ctx, {
            type: 'line',
            data: { labels: res.dates, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: { y: { display: true, grid: { color: '#f1f5f9' } }, x: { display: false } },
                plugins: { legend: { display: true }, tooltip: { callbacks: { label: (c)=>`${c.dataset.label}: ${c.raw.toFixed(0)}` } } }
            }
        });
    }

    function renderRollingCharts(res) {
        // Calculate Rolling Returns
        const curve = res.curve;
        const benchCurve = res.benchCurve; // Get benchmark curve
        const horizons = res.rollSettings.horizons;
        const step = res.rollSettings.rollStep;
        
        // Data structures
        const ranges = { labels: [], min: [], max: [], avg: [], benchAvg: [] };
        const winProbs = { labels: [], strat: [], bench: [] };
        const expected = { labels: [], strat: [], bench: [] };

        horizons.forEach(yr => {
            const days = yr * 252;
            const rets = [];
            const benchRets = [];
            
            // Strategy Rolling
            for(let i=0; i < curve.length - days; i += step) {
                const startV = curve[i];
                const endV = curve[i+days];
                const annRet = (Math.pow(endV/startV, 1/yr) - 1) * 100;
                rets.push(annRet);

                // Benchmark Rolling
                if(benchCurve && benchCurve.length > i+days) {
                     const bStart = benchCurve[i];
                     const bEnd = benchCurve[i+days];
                     const bAnnRet = (Math.pow(bEnd/bStart, 1/yr) - 1) * 100;
                     benchRets.push(bAnnRet);
                }
            }

            if(rets.length > 0) {
                // Strategy Stats
                const min = Math.min(...rets);
                const max = Math.max(...rets);
                const avg = rets.reduce((a,b)=>a+b,0)/rets.length;
                const wins = rets.filter(x=>x>0).length;

                // Bench Stats
                let bAvg = 0;
                let bWins = 0;
                if(benchRets.length > 0) {
                    bAvg = benchRets.reduce((a,b)=>a+b,0)/benchRets.length;
                    bWins = benchRets.filter(x=>x>0).length;
                }
                
                ranges.labels.push(`${yr}Y`);
                ranges.min.push(min);
                ranges.max.push(max);
                ranges.avg.push(avg);
                ranges.benchAvg.push(bAvg);

                winProbs.labels.push(`${yr}Y`);
                winProbs.strat.push((wins/rets.length)*100);
                winProbs.bench.push(benchRets.length ? (bWins/benchRets.length)*100 : 0);

                expected.labels.push(`${yr}Y`);
                expected.strat.push(avg);
                expected.bench.push(bAvg);
            }
        });

        // 1. Range Chart (Added Bench Avg line)
        destroyChart('chart-range');
        charts['chart-range'] = new Chart(document.getElementById('chart-range'), {
            type: 'bar',
            data: {
                labels: ranges.labels,
                datasets: [
                    { label: 'Max', data: ranges.max, backgroundColor: '#60a5fa', order: 2 }, 
                    { label: 'Strat Avg', data: ranges.avg, type: 'line', borderColor: '#1e40af', borderWidth: 2, pointRadius: 4, tension: 0.1, order: 0 },
                    { label: 'Bench Avg', data: ranges.benchAvg, type: 'line', borderColor: '#94a3b8', borderWidth: 2, borderDash: [5,5], pointRadius: 3, tension: 0.1, order: 1 },
                    { label: 'Min', data: ranges.min, backgroundColor: '#f43f5e', order: 3 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { title: { display: false } },
                scales: { y: { grid: { color: '#f1f5f9' }, title: {display:true, text: 'Annualized Return (%)'} } }
            }
        });

        // 2. Win Prob Chart (Grouped)
        destroyChart('chart-loss');
        charts['chart-loss'] = new Chart(document.getElementById('chart-loss'), {
            type: 'bar',
            data: {
                labels: winProbs.labels,
                datasets: [
                    { label: 'Strategy Win %', data: winProbs.strat, backgroundColor: '#10b981' },
                    { label: 'Bench Win %', data: winProbs.bench, backgroundColor: '#94a3b8' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { min: 0, max: 100 } }
            }
        });

        // 3. Expected Return Chart (Grouped)
        destroyChart('chart-expected');
        charts['chart-expected'] = new Chart(document.getElementById('chart-expected'), {
            type: 'bar',
            data: {
                labels: expected.labels,
                datasets: [
                    { label: 'Strategy Avg %', data: expected.strat, backgroundColor: '#6366f1' },
                    { label: 'Bench Avg %', data: expected.bench, backgroundColor: '#94a3b8' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false
            }
        });
    }

    // --- INIT ---
    window.onload = () => {
        // Set Default Dates
        const today = new Date();
        document.getElementById('date-end').value = today.toISOString().split('T')[0];
        const start = new Date(); start.setFullYear(today.getFullYear() - 20); // 20 years back
        document.getElementById('date-start').value = start.toISOString().split('T')[0];
        
        renderAssetList();
        updateStrategyDesc();
    };

</script>
</body>
</html>
